// Backbone.Epoxy 0.9.0
// (c) 2013 Greg MacWilliam
// Freely distributed under the MIT license
// http://epoxyjs.org
(function(){function t(t){return function(e,n,i){return t.prototype[n].apply(e,i)}}function e(t,n,i,s){for(var r in n)if(n.hasOwnProperty(r)){var o=n[r];if(t.hasObservable(r)){if(s.length&&!(0>h.indexOf(s,r)))throw"Recursive setter: "+s.join(" > ");o=t.obs[r].set(o),o&&f(o)&&(i=e(t,o,i,s.slice().concat([r])))}else i[r]=o}return i}function n(t,e,n){if(t){if(l(t)&&(t=t()),v(t)){var i=n?n+"_":"",s=h.extend({},t.attributes,t.obs||{});e["$"+(n||"model")]=function(){return m&&m.push([t,"change"]),t},h.each(s,function(n,s){e[i+s]=function(e){return m&&m.push([t,"change:"+s]),u(e)?t.get(s):f(e)&&!d(e)?t.set(e):t.set(s,e)}})}else g(t)&&(e["$"+(n||"collection")]=function(){return m&&m.push([t,"reset add remove sort"]),t});return t}}function i(t){return l(t)?t():(f(t)&&(t=d(t)?t.slice():h.clone(t),h.each(t,function(e,n){t[n]=i(e)})),t)}var s,r=this,o=r.Backbone,h=r._,a=o.Epoxy={},c=Array.prototype,u=h.isUndefined,l=h.isFunction,f=h.isObject,d=h.isArray,v=function(t){return t instanceof o.Model},g=function(t){return t instanceof o.Collection},p=t(o.Model);a.Model=o.Model.extend({constructor:function(){this.obs={},p(this,"constructor",arguments),this._init=!0,this.observableDefaults&&h.each(this.observableDefaults,function(t,e){this.addObservable(e,l(t)?t():t)},this),this.computeds&&h.each(this.computeds,function(t,e){this.addComputed(e,t)},this),h.each(this.obs,function(t){t.init()}),delete this._init},get:function(t){return s&&s.push([t,this]),this.hasObservable(t)?this.obs[t].get():p(this,"get",arguments)},getCopy:function(t){var e=this.get(t);return d(e)?e.slice():f(e)?h.clone(e):e},set:function(t,n,i){var s=t;return s&&!f(s)?(s={},s[t]=n):i=n,i=i||{},i.unset||(s=e(this,s,{},[])),p(this,"set",[s,i])},destroy:function(){return this.clearObservables(),p(this,"destroy",arguments)},addObservable:function(t,e){return this.removeObservable(t),this.obs[t]=new b(this,t,{value:e}),this},addComputed:function(t,e,n){this.removeObservable(t);var i=e;if(l(e)){var s=2;i={},i._get=e,l(n)&&(i._set=n,s++),i.deps=c.slice.call(arguments,s)}return this.obs[t]=new b(this,t,i),this},hasObservable:function(t){return this.obs.hasOwnProperty(t)},removeObservable:function(t){return this.hasObservable(t)&&(this.obs[t].dispose(),delete this.obs[t]),this},clearObservables:function(){for(var t in this.obs)this.removeObservable(t);return this},modifyArray:function(t,e){var n=this.get(t);if(d(n)&&l(c[e])){var i=c.slice.call(arguments,2),s=c[e].apply(n,i);return this.trigger("change change:"+t),s}return null},modifyObject:function(t,e,n){var i=this.get(t),s=!1;return f(i)?(u(n)&&i.hasOwnProperty(e)?(delete i[e],s=!0):i[e]!==n&&(i[e]=n,s=!0),s&&this.trigger("change change:"+t),i):null}});var b=function(t,e,n){n=n||{},n.get&&l(n.get)&&(n._get=n.get),n.set&&l(n.set)&&(n._set=n.set),delete n.get,delete n.set,h.extend(this,n),this.model=t,this.name=e,this.deps=this.deps||[],t._init||this.init()};h.extend(b.prototype,o.Events,{init:function(){if(s=this.deps,this.get(!0),s=null,this.deps.length){var t={};h.each(this.deps,function(e){var n=this.model;d(e)&&(n=e[1],e=e[0]),e.indexOf("change:")&&(e="change:"+e),t.hasOwnProperty(e)?h.contains(t[e],n)||t[e].push(n):t[e]=[n]},this),h.each(t,function(t,e){for(var n=0,i=t.length;i>n;n++)this.listenTo(t[n],e,h.bind(this.get,this,!0))},this)}},get:function(t){if(t===!0&&this._get){var e=this._get.call(this.model);this.change(e)}return this.value},set:function(t){if(this._get){if(this._set)return this._set.apply(this.model,arguments);throw"Cannot set read-only computed observable."}return this.change(t),null},fire:function(){this.model.trigger("change change:"+this.name)},change:function(t){h.isEqual(t,this.value)||(this.value=t,this.fire())},dispose:function(){this.stopListening(),this.off(),this.model=this.value=null}});var m,y=t(o.View);a.View=o.View.extend({constructor:function(){this._bind=[],y(this,"constructor",arguments),this.applyBindings()},bindings:"data-bind",applyBindings:function(){function t(t,n,i){try{e._bind.push(new _(t,n,r,s))}catch(o){throw'Error parsing bindings for "'+i+'" >> '+o}}if(this.removeBindings(),this.model||this.collection){var e=this,i=this.bindingSources,s=h.clone(w),r={};if(h.each(e.bindingHandlers||{},function(t,e){s[e]=l(t)?{set:t}:t}),e.model=n(e.model,r),e.collection=n(e.collection,r),h.each(i,function(t,e){i[e]=n(t,r,e)}),f(this.bindings))h.each(this.bindings,function(e,n){var i=this.$(n);this.$el.is(n)&&(i=i.add(this.$el)),i.length&&t(i,e,n)},this);else{var o=this.bindings,a="["+o+"]",c=this.$(a);this.$el.is(a)&&(c=c.add(this.$el)),c.each(function(e){e=$(this),t(e,e.attr(o),a)})}}},removeBindings:function(){for(;this._bind.length;)this._bind.pop().dispose()},remove:function(){this.removeBindings(),y(this,"remove")}});var w={attr:{set:function(t,e){t.attr(e)}},checked:{get:function(t,e){var n=!!t.prop("checked"),i=t.val();if(t.is(":radio"))return i;if(d(e)){e=e.slice();var s=h.indexOf(e,i);return n&&0>s?e.push(i):!n&&s>-1&&e.splice(s,1),e}return n},set:function(t,e){var n=!!e;t.is(":radio")?n=e==t.val():d(e)&&(n=h.contains(e,t.val())),t.prop("checked",n)}},classes:{set:function(t,e){h.each(e,function(e,n){t.toggleClass(n,!!e)})}},collection:{set:function(t,e,n){if(!g(e)||!l(e.view))throw"Binding 'collection:' requires a Collection with a 'view' constructor.";var i,s=e.models,r=this.v;if(n=n||e,v(n))if(r.hasOwnProperty(n.cid))i=r[n.cid],i.remove(),delete r[n.cid];else{r[n.cid]=i=new e.view({model:n});var o=h.indexOf(s,n);o>t.children().length?t.eq(o).before(i.$el):t.append(i.$el)}else if(g(n)){var a=s.length&&h.every(s,function(t){return r.hasOwnProperty(t.cid)});t.hide(),a?e.each(function(e){t.append(r[e.cid].$el)}):(this.empty(),e.each(function(n){r[n.cid]=i=new e.view({model:n}),t.append(i.$el)})),t.show()}}},css:{set:function(t,e){t.css(e)}},disabled:{set:function(t,e){t.prop("disabled",!!e)}},enabled:{set:function(t,e){t.prop("disabled",!e)}},html:{set:function(t,e){t.html(e)}},text:{set:function(t,e){t.text(e)}},toggle:{set:function(t,e){t.toggle(!!e)}},value:{get:function(t){return t.val()},set:function(t,e){t.val()!=e&&t.val(e)}}},O={all:function(){var t=arguments;return function(){for(var e=!0,n=0,s=t.length;s>n;n++)i(t[n])||(e=!1);return e}},any:function(){var t=arguments;return function(){for(var e=!1,n=0,s=t.length;s>n;n++)i(t[n])&&(e=!0);return e}},length:function(t){return function(){return i(t).length||0}},none:function(){var t=arguments;return function(){for(var e=!0,n=0,s=t.length;s>n;n++)i(t[n])&&(e=!1);return e}},not:function(t){return function(){return!i(t)}},format:function(){var t=arguments;return function(){for(var e=i(t[0]),n=1,s=t.length;s>n;n++)e=e.replace(RegExp("\\$"+n,"g"),i(t[n]));return e}},select:function(){var t=arguments;return function(){var e=i(t[0]),n=i(t[1]),s=i(t[2]);return e?n:s}}},_=function(t,e,n,s){this.$el=t,this.v={};var r=this,o=t[0].tagName.toLowerCase(),a="input"==o||"select"==o||"textarea"==o,c=Function("$o","$a","with($o){with($a){return{"+e+"}}}"),u=["change"];e=c(O,n),e.events&&(u=d(e.events)?h.union(u,e.events):u,delete e.events),this.events=h.map(u,function(t){return t+".epoxy"}).join(" "),h.each(e,function(t,e){if(!s.hasOwnProperty(e))throw"invalid binding => "+e;var n=s[e],o=[];if(m=o,n.set.call(r,r.$el,i(t)),m=null,a&&n.get&&l(t)&&r.$el.on(r.events,function(){t(n.get.call(r,r.$el,i(t)))}),o.length)for(var h=function(e){n.set.call(r,r.$el,i(t),e)},c=0,u=o.length;u>c;c++)r.listenTo(o[c][0],o[c][1],h)})};h.extend(_.prototype,o.Events,{empty:function(){for(var t in this.v)this.v.hasOwnProperty(t)&&(this.v[t].remove(),delete this.v[t])},dispose:function(){this.empty(),this.stopListening(),this.$el.off(this.events),this.$el=null}})}).call(this);